<?xml version="1.0"?>
<exercises>
  <exercise>
    <title>Malware Analysis - Windows - Part 4</title>
    <difficulty>3</difficulty>
    <category>CND</category>
    <name>Malware_Analysis_P4</name>
    <dependencies>Malware_Analysis_P3</dependencies>
    <shortdescription>Analyze Malicious Windows Programs: Lab 11-1</shortdescription>
    <description>In this exercise you will analyze malicious windows programs using native windows commands and a debugger. The malicious application comes from Practical Malware Analysis, Chapter 11. </description>
    <tutorial>&lt;p&gt;Before running the malware, read through Chapter 11 of Practical Malware Analysis. It will help with doing the malware analysis exercises.&lt;/p&gt;&#xD;
&lt;ol&gt;&#xD;
&lt;li&gt;Using your defense workstation, open up the directory in the share drive 'ShareFiles(S:)\Practical Malware Analysis Labs\BinaryCollection\Chapter11L'.&lt;/li&gt;&#xD;
&lt;li&gt;Select 'Lab11_02.exe' and run it.&amp;nbsp;&lt;/li&gt;&#xD;
&lt;li&gt;Analyze the malware using native windows commands, and the debugger of your choice. Assume that a suspicious file named Lab11-02.ini was also found with this malware.&lt;/li&gt;&#xD;
&lt;/ol&gt;</tutorial>
    <question>
      <text>What are the exports for this DLL malware?</text>
      <type>multiple</type>
      <answer>Installer.</answer>
      <wrong>RegSetValueEx</wrong>
      <wrong>CopyFile</wrong>
      <wrong>CreateToolhelp32Snapshot</wrong>
    </question>
    <question>
      <text>What happens after you attempt to install this malware using rundll32.exe?</text>
      <type>multiple</type>
      <answer>The malware copies itself to the System32 directory as spoolvxx32.dll and installs itself persistently under AppInit_DLLs. The malware also tries to open Lab11-02.ini, but fails.</answer>
      <wrong>The malware copies itself to the Windows system directory as spoolvxx32.dll and installs itself persistently under HKLM\Software\Microsoft\Windows NT\CurrentVersion\WinLogon. The malware also tries to open Lab11-02.ini from the Windows system directory, but it doesn&#x2019;t find it there.</wrong>
      <wrong>The malware copies itself to the Windows system directory as rundl132.dll and installs itself persistently under HKLM\Software\Microsoft\Windows NT\CurrentVersion\WinLogon. The malware also tries to open Lab11-02.ini from the Windows system directory, but it doesn&#x2019;t find it there.</wrong>
      <wrong>The malware copies itself to the Windows system directory as rundl132.dll and installs itself persistently under AppInit_DLLs. The malware also tries to open Lab11-02.ini from the Windows system directory, but it doesn&#x2019;t find it there.</wrong>
    </question>
    <question>
      <text>Where must Lab11-02.ini reside in order for the malware to install properly?</text>
      <type>multiple</type>
      <answer>%SystemRoot%\System32\ </answer>
      <wrong>%SystemRoot%\Temp\</wrong>
      <wrong>%SystemRoot%\System\ </wrong>
      <wrong>%SystemRoot%\SystemResources\ </wrong>
    </question>
    <question>
      <text>How is this malware installed for persistence?</text>
      <type>multiple</type>
      <answer>HKLM\Software\Microsoft\Windows NT\CurrentVersion\AppInit_DLLs, which causes the malware to be loaded into every process that also loads User32.dll.</answer>
      <wrong>Scheduled Job</wrong>
      <wrong>HKLM\System\CurrentControlSet\Services</wrong>
      <wrong>HKLM\Software\Microsoft\Windows NT\CurrentVersion\Winlogon</wrong>
    </question>
    <question>
      <text>What user-space rootkit technique does this malware employ?</text>
      <type>multiple</type>
      <answer>inline hooking of the send function</answer>
      <wrong>IAT hooking of User32.dll</wrong>
      <wrong>inline hooking of the function sub_100010B3</wrong>
      <wrong>IAT hooking of Kernel32.dll</wrong>
    </question>
    <question>
      <text>What does the hooking code do?</text>
      <type>multiple</type>
      <answer>The hook checks if the outgoing packet is an email message containing RCPT TO:, and if this string is found, it adds an additional RCPT TO line containing a malicious email account.</answer>
      <wrong>the hook checks if the Lab11_02.ini file size is greater than o, if yes then it passes to the sub_100010B3 function.</wrong>
      <wrong>the hook passes esp the address of wsock32.dll, and opens port 8081 to start listening.</wrong>
      <wrong>the hook checks if the Lab11_02.ini file has a hidden property or not, and sets it to hidden if it isn't.</wrong>
    </question>
    <question>
      <text>Which process(es) does this malware attack and why?</text>
      <type>multiple</type>
      <answer>The malware targets only MSIMN.exe, THEBAT.exe, and OUTLOOK.exe because all are email clients. The malware does not install the hook unless it is running inside one of these processes.</answer>
      <wrong>The malware targets svchost.exe, so that it can better hide among the legitimate services.</wrong>
      <wrong>The malware targets services.exe, so that it can install the hook in order for it to start up when the computer starts.</wrong>
      <wrong>The malware targets lsass.exe, so that it can install the hook and start up anytime you login.</wrong>
    </question>
    <question>
      <text>What is the significance of the .ini file?</text>
      <type>multiple</type>
      <answer>The .ini file contains an encrypted email address. After decrypting Lab11-02.ini, we see it contains billy@malwareanalysisbook.com.</answer>
      <wrong>The .ini file is encrypted and contains network code to open up the listening tcp port 8081.</wrong>
      <wrong>The .ini file is encrypted and contains the stolen credentials of all users on the box.</wrong>
      <wrong>The .ini file is encrypted and contains captured traffic of all interfaces on the box.</wrong>
    </question>
  </exercise>
</exercises>
